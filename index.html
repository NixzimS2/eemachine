<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RefriComunit√°rio - Vending Machine Social</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzTBTgdujTM2WGYkaUlHZpvJeoVRqn65o",
            authDomain: "maquina-de-refrigerante.firebaseapp.com",
            databaseURL: "https://maquina-de-refrigerante-default-rtdb.firebaseio.com",
            projectId: "maquina-de-refrigerante",
            storageBucket: "maquina-de-refrigerante.appspot.com",
            messagingSenderId: "857635152294",
            appId: "1:857635152294:web:7123a876c7a2116470de7",
            measurementId: "G-J2D7T7J0W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        console.log("‚úÖ Firebase inicializado com sucesso!");

        // Fun√ß√µes globais
        window.firebaseApp = app;
        window.firebaseDB = db;
        window.firebaseAuth = auth;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseUpdate = update;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseCreateUser = createUserWithEmailAndPassword;
        window.firebaseAuthStateChanged = onAuthStateChanged;
        window.firebaseSignOut = signOut;

        // FUN√á√ÉO PARA SOLTAR REFRIGERANTE - CONECTA COM ESP32
        window.soltarRefrigerante = async function (motor, bebida) {
            try {
                const comandoRef = window.firebaseRef(window.firebaseDB, `comandos/motor${motor}`);
                await window.firebaseSet(comandoRef, {
                    acionar: true,
                    bebida: bebida,
                    timestamp: new Date().toISOString(),
                    duracao: 4000,
                    completado: false
                });
                
                console.log(`üéØ Comando enviado para ESP32: Motor ${motor} - ${bebida}`);
                return true;
                
            } catch (error) {
                console.error("Erro ao acionar motor:", error);
                throw error;
            }
        }

        // FUN√á√ÉO PARA PAUSAR/DESPAUSAR BOMBA
        window.pausarBomba = async function (pausar) {
            try {
                const bombaRef = window.firebaseRef(window.firebaseDB, "bombaPausada");
                await window.firebaseSet(bombaRef, pausar);
                
                const status = pausar ? 'PAUSADA' : 'ATIVADA';
                console.log(`‚è∏Ô∏è Bomba ${status} com sucesso!`);
                return true;
                
            } catch (error) {
                console.error("Erro ao pausar bomba:", error);
                throw error;
            }
        }

        // MONITORAR STATUS DO ESP32
        window.monitorarMotores = function(callback) {
            try {
                const motoresRef = window.firebaseRef(window.firebaseDB, "comandos");
                window.firebaseOnValue(motoresRef, (snapshot) => {
                    if (snapshot.exists()) {
                        callback(snapshot.val());
                    }
                });
            } catch (error) {
                console.error("Erro ao monitorar motores:", error);
            }
        }

        // MONITORAR STATUS DA BOMBA
        window.monitorarBomba = function(callback) {
            try {
                const bombaRef = window.firebaseRef(window.firebaseDB, "bombaPausada");
                window.firebaseOnValue(bombaRef, (snapshot) => {
                    const isPaused = snapshot.exists() ? snapshot.val() : false;
                    callback(isPaused);
                });
            } catch (error) {
                console.error("Erro ao monitorar bomba:", error);
            }
        }

        // FUN√á√ÉO PARA LIGAR/DESLIGAR M√ÅQUINA
        window.enviarComando = async function (valor) {
            try {
                const comandoRef = window.firebaseRef(window.firebaseDB, "comando");
                await window.firebaseSet(comandoRef, valor);
                
                const status = valor === 1 ? 'LIGADA' : 'DESLIGADA';
                alert(`M√°quina ${status} com sucesso!`);
                
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao enviar comando para a m√°quina");
            }
        }
    </script>

    <!-- ESTILOS COMPLETOS FRU FRU -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
        }

        /* Efeito de part√≠culas no fundo */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 4px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 4px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            z-index: -1;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { background-position: 0 0, 40px 60px, 130px 270px; }
            100% { background-position: 550px 550px, 390px 410px, 380px 520px; }
        }

        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            z-index: 1;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        header h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            text-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
            display: inline-block;
            background: linear-gradient(90deg, #ff9a9e, #fad0c4, #fad0c4, #a1c4fd, #c2e9fb);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .machine-control {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 1;
            min-width: 120px;
        }

        .control-btn.ligar { 
            background: linear-gradient(145deg, #00b09b, #96c93d);
            color: white;
        }

        .control-btn.desligar { 
            background: linear-gradient(145deg, #ff416c, #ff4b2b);
            color: white;
        }

        .control-btn.pausar { 
            background: linear-gradient(145deg, #ffa500, #ff8c00);
            color: white;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            font-size: 1rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff416c;
            box-shadow: 0 0 10px #ff416c;
            animation: blink 2s infinite;
        }

        .status-indicator.connected {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }

        /* BOMBA STATUS */
        .bomba-status-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bomba-status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
            animation: pulse 2s infinite;
        }

        .bomba-status-indicator.pausada {
            background: #ffa500;
            box-shadow: 0 0 10px #ffa500;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(0, 255, 136, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0); }
        }

        /* SE√á√ÉO MOTORES */
        .motors-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid;
            border-image: linear-gradient(90deg, transparent, #00c6ff, transparent) 1;
            background: linear-gradient(90deg, #ff9a9e, #a1c4fd);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .motors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .motor-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .motor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .motor-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #00c6ff;
            text-shadow: 0 0 10px rgba(0, 198, 255, 0.5);
        }

        .motor-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .motor-select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .motor-action {
            margin-top: 20px;
        }

        .release-btn {
            background: linear-gradient(145deg, #ff9a9e, #fad0c4);
            color: #333;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .release-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 154, 158, 0.4);
        }

        .release-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .motor-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(0, 198, 255, 0.1);
            border: 1px solid rgba(0, 198, 255, 0.3);
        }

        .motor-status.acionando {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            animation: pulse 1s infinite;
        }

        .motor-status.completado {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid rgba(0, 255, 136, 0.5);
        }

        .motor-status.erro {
            background: rgba(255, 65, 108, 0.2);
            border: 1px solid rgba(255, 65, 108, 0.5);
        }

        .motor-info {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* ABAS */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            border: none;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .tab.active {
            background: linear-gradient(145deg, #00c6ff, #0072ff);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* SE√á√ïES PRINCIPAIS */
        .products-section, .cart-section, .auth-section, .lead-time, .admin-section {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 25px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        /* PRODUTOS */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
        }

        .product-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.03);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }

        .product-image {
            width: 80px;
            height: 120px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            color: #00c6ff;
            text-shadow: 0 0 10px rgba(0, 198, 255, 0.5);
        }

        .product-name {
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .product-details {
            font-size: 0.95rem;
            opacity: 0.8;
            margin-bottom: 12px;
        }

        .product-stock {
            font-size: 0.9rem;
            color: #00ff88;
            margin-bottom: 20px;
            text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
        }

        /* BOT√ïES */
        .add-to-cart, .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 1rem;
        }

        .add-to-cart {
            background: linear-gradient(145deg, #00c6ff, #0072ff);
            color: white;
            width: 100%;
        }

        .add-to-cart:hover:not(:disabled) {
            background: linear-gradient(145deg, #0072ff, #00c6ff);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 114, 255, 0.4);
        }

        .btn-primary {
            background: linear-gradient(145deg, #00b09b, #96c93d);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(145deg, #96c93d, #00b09b);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 176, 155, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
        }

        /* CARRINHO */
        .cart-items {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .cart-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quantity-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .quantity-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .remove-btn {
            background: linear-gradient(145deg, #ff416c, #ff4b2b);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
        }

        .cart-total {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin: 25px 0;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* LOGIN */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 50px 40px;
            border-radius: 25px;
            width: 90%;
            max-width: 450px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .login-box h2 {
            font-size: 2.2rem;
            margin-bottom: 30px;
            background: linear-gradient(90deg, #ff9a9e, #a1c4fd);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            text-align: left;
        }

        .form-group label {
            font-weight: 600;
            color: #00c6ff;
            font-size: 1.1rem;
        }

        .form-group input {
            padding: 18px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00c6ff;
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
        }

        .auth-buttons {
            display: flex;
            gap: 20px;
            margin-top: 25px;
        }

        /* USER INFO */
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(145deg, #00c6ff, #0072ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 5px 15px rgba(0, 114, 255, 0.4);
        }

        /* LEAD TIME */
        .lead-time-calc {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .lead-time-result {
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            padding: 25px;
            background: linear-gradient(145deg, #00b09b, #96c93d);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 176, 155, 0.4);
        }

        /* ADMIN SECTION */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            margin: 15px 0;
            color: #00c6ff;
            text-shadow: 0 0 10px rgba(0, 198, 255, 0.5);
        }

        .withdrawals-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 25px;
        }

        .withdrawal-item {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .withdrawal-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        /* FOOTER */
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            opacity: 0.8;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* RESPONSIVIDADE */
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .machine-control {
                position: static;
                justify-content: center;
                margin-top: 20px;
            }
            
            .container {
                padding: 20px;
            }
            
            header h1 {
                font-size: 2.2rem;
            }
            
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .control-btn {
                padding: 10px 20px;
                font-size: 13px;
                min-width: 100px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            .tab {
                padding: 15px 10px;
                font-size: 0.9rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .login-box {
                padding: 30px 20px;
            }
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        button:disabled:hover {
            transform: none !important;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3) !important;
        }
    </style>
</head>
<body>
    <!-- Overlay de Login -->
    <div class="login-overlay" id="login-overlay">
        <div class="login-box">
            <h2>Bem-vindo ao RefriComunit√°rio</h2>
            <div class="auth-form">
                <div class="form-group">
                    <label for="login-email">E-mail</label>
                    <input type="email" id="login-email" placeholder="seu.email@comunidade.com">
                </div>
                <div class="form-group">
                    <label for="login-password">Senha</label>
                    <input type="password" id="login-password" placeholder="Sua senha">
                </div>
                <div class="auth-buttons">
                    <button class="btn btn-primary" id="overlay-login-btn">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                    <button class="btn btn-secondary" id="overlay-register-btn">
                        <i class="fas fa-user-plus"></i> Cadastrar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container" id="main-container" style="display: none;">
        <header>
            <div class="machine-control">
                <button class="control-btn ligar" onclick="enviarComando(1)">
                    <i class="fas fa-power-off"></i> LIGAR
                </button>
                <button class="control-btn desligar" onclick="enviarComando(0)">
                    <i class="fas fa-power-off"></i> DESLIGAR
                </button>
                <button class="control-btn pausar" id="pausar-bomba-btn" onclick="alternarPausaBomba()">
                    <i class="fas fa-pause"></i> PAUSAR
                </button>
            </div>
            
            <h1><i class="fas fa-wine-bottle"></i> RefriComunit√°rio</h1>
            <p>Vending Machine Social - Distribui√ß√£o Controlada de Refrigerantes</p>
            
            <div class="connection-status">
                <div class="status-indicator" id="firebase-status"></div>
                <span id="firebase-status-text">Conectando ao Firebase...</span>
            </div>
            
            <div class="bomba-status-container">
                <div class="bomba-status-indicator" id="bomba-status-indicator"></div>
                <span id="bomba-status-text">Status da Bomba: Verificando...</span>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('user')">√Årea do Usu√°rio</div>
            <div class="tab" onclick="switchTab('admin')">Relat√≥rios (ONG/Parceiro)</div>
        </div>
        
        <div id="user-tab" class="tab-content active">
            <!-- SE√á√ÉO: MOTORES CONECTADOS AO ESP32 -->
            <div class="motors-section">
                <h2 class="section-title">üéÆ Controle dos Motores - ESP32</h2>
                <p style="text-align: center; margin-bottom: 20px; opacity: 0.8;">
                    <i class="fas fa-microchip"></i> Conectado diretamente ao ESP32 via Firebase
                </p>
                <div class="motors-grid">
                    <div class="motor-card">
                        <div class="motor-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <h3 class="motor-title">Motor 1 - ESP32</h3>
                        <select class="motor-select" id="motor1-select">
                            <option value="">Selecione uma bebida</option>
                            <option value="coca-cola">ü•§ Coca-Cola</option>
                            <option value="guarana">ü•§ Guaran√° Antarctica</option>
                            <option value="fanta">ü•§ Fanta Laranja</option>
                        </select>
                        <div class="motor-action">
                            <button class="release-btn" id="motor1-release" disabled>
                                <i class="fas fa-cog"></i> Soltar Refrigerante
                            </button>
                        </div>
                        <div class="motor-status ready" id="motor1-status">
                            <i class="fas fa-check-circle motor-status-icon"></i>
                            <span>Pronto para uso</span>
                            <div class="motor-info" id="motor1-info">Aguardando comando...</div>
                        </div>
                    </div>
                    
                    <div class="motor-card">
                        <div class="motor-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <h3 class="motor-title">Motor 2 - ESP32</h3>
                        <select class="motor-select" id="motor2-select">
                            <option value="">Selecione uma bebida</option>
                            <option value="coca-cola">ü•§ Coca-Cola</option>
                            <option value="guarana">ü•§ Guaran√° Antarctica</option>
                            <option value="fanta">ü•§ Fanta Laranja</option>
                        </select>
                        <div class="motor-action">
                            <button class="release-btn" id="motor2-release" disabled>
                                <i class="fas fa-cog"></i> Soltar Refrigerante
                            </button>
                        </div>
                        <div class="motor-status ready" id="motor2-status">
                            <i class="fas fa-check-circle motor-status-icon"></i>
                            <span>Pronto para uso</span>
                            <div class="motor-info" id="motor2-info">Aguardando comando...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <div class="products-section">
                    <h2 class="section-title">üçπ Cat√°logo de Refrigerantes</h2>
                    <div class="products-grid" id="products-grid">
                        <!-- Produtos ser√£o carregados do Firebase -->
                    </div>
                </div>
                
                <div class="cart-section">
                    <h2 class="section-title">üõí Carrinho de Retiradas</h2>
                    <div class="cart-items" id="cart-items">
                        <!-- Itens do carrinho -->
                    </div>
                    <div class="cart-total" id="cart-total">
                        Total de Itens: 0
                    </div>
                    <button class="btn btn-primary" id="checkout-btn" disabled>
                        <i class="fas fa-check-circle"></i> Confirmar Retirada
                    </button>
                </div>
            </div>
            
            <div class="auth-section">
                <h2 class="section-title">Informa√ß√µes do Usu√°rio</h2>
                <div class="user-info" id="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <h3 id="user-name">Visitante</h3>
                        <p id="user-details">Fa√ßa login para retirar produtos</p>
                    </div>
                    <button class="btn btn-secondary" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
            
            <div class="lead-time">
                <h2 class="section-title">Previs√£o de Retirada</h2>
                <div class="lead-time-calc">
                    <p>Tempo fixo da m√°quina: <strong>2 minutos</strong></p>
                    <p>Tempo de reposi√ß√£o per item: <strong>30 segundos</strong></p>
                    <p>F√≥rmula: <strong>Lead Time = 2 min + (Quantidade √ó 30 seg)</strong></p>
                </div>
                <div class="lead-time-result" id="lead-time-result">
                    Tempo estimado: 0 minutos
                </div>
            </div>
        </div>
        
        <div id="admin-tab" class="tab-content">
            <div class="admin-section">
                <h2 class="section-title">Relat√≥rios para ONG/Parceiro</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Retiradas Hoje</h3>
                        <div class="stat-value" id="today-withdrawals">0</div>
                        <p>Refrigerantes distribu√≠dos</p>
                    </div>
                    <div class="stat-card">
                        <h3>Usu√°rios Ativos</h3>
                        <div class="stat-value" id="active-users">0</div>
                        <p>Este m√™s</p>
                    </div>
                    <div class="stat-card">
                        <h3>Itens em Estoque</h3>
                        <div class="stat-value" id="total-stock">0</div>
                        <p>Refrigerantes dispon√≠veis</p>
                    </div>
                    <div class="stat-card">
                        <h3>Custo Parceiro</h3>
                        <div class="stat-value" id="partner-cost">R$ 0,00</div>
                        <p>Este m√™s</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 30px;">√öltimas Retiradas</h3>
                <div class="withdrawals-list" id="withdrawals-list">
                    <!-- Hist√≥rico de retiradas do Firebase -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>RefriComunit√°rio &copy; 2023 - Sistema de Vending Machine Social</p>
            <p>Projeto acad√™mico - Distribui√ß√£o controlada de refrigerantes em comunidades</p>
        </footer>
    </div>

    <script>
        // Dados iniciais
        let products = [];
        let cart = [];
        let currentUser = null;
        let withdrawals = [];
        let isMachineActive = false;
        let isBombaPausada = false;

        // Configura√ß√µes dos motores
        let motor1Beverage = '';
        let motor2Beverage = '';

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            setupEventListeners();
            checkMachineStatus();
            setupMotorListeners();
            startMotorMonitoring();
            startBombaMonitoring();
        });

        // ‚úÖ CONECTA COM O ESP32 - Monitora status em tempo real
        function startMotorMonitoring() {
            window.monitorarMotores((motores) => {
                console.log("üì° Dados recebidos do ESP32:", motores);
                updateMotorStatus(motores);
            });
        }

        // ‚úÖ MONITORAR STATUS DA BOMBA
        function startBombaMonitoring() {
            window.monitorarBomba((isPaused) => {
                isBombaPausada = isPaused;
                updateBombaStatusUI(isPaused);
                console.log(`üíß Status da Bomba: ${isPaused ? 'PAUSADA' : 'ATIVA'}`);
            });
        }

        // Atualizar status da bomba na interface
        function updateBombaStatusUI(isPaused) {
            const bombaIndicator = document.getElementById('bomba-status-indicator');
            const bombaStatusText = document.getElementById('bomba-status-text');
            const pausarBtn = document.getElementById('pausar-bomba-btn');
            
            if (isPaused) {
                bombaIndicator.className = 'bomba-status-indicator pausada';
                bombaStatusText.textContent = 'Status da Bomba: ‚è∏Ô∏è PAUSADA';
                pausarBtn.innerHTML = '<i class="fas fa-play"></i> DESPAUSAR';
                pausarBtn.style.background = 'linear-gradient(145deg, #00b09b, #96c93d)';
            } else {
                bombaIndicator.className = 'bomba-status-indicator';
                bombaStatusText.textContent = 'Status da Bomba: ‚ñ∂Ô∏è ATIVA';
                pausarBtn.innerHTML = '<i class="fas fa-pause"></i> PAUSAR';
                pausarBtn.style.background = 'linear-gradient(145deg, #ffa500, #ff8c00)';
            }
        }

        // Fun√ß√£o para alternar pausa da bomba
        async function alternarPausaBomba() {
            if (!isMachineActive) {
                alert('A m√°quina est√° desligada. Ligue-a primeiro para controlar a bomba.');
                return;
            }

            try {
                const novoStatus = !isBombaPausada;
                await window.pausarBomba(novoStatus);
                
                const statusText = novoStatus ? 'pausada' : 'ativada';
                alert(`Bomba ${statusText} com sucesso!`);
                
            } catch (error) {
                console.error('Erro ao controlar bomba:', error);
                alert('Erro ao controlar a bomba. Verifique a conex√£o.');
            }
        }

        // Atualizar status dos motores baseado no ESP32
        function updateMotorStatus(motores) {
            for (let motor = 1; motor <= 2; motor++) {
                const motorKey = `motor${motor}`;
                const statusElement = document.getElementById(`${motorKey}-status`);
                const infoElement = document.getElementById(`${motorKey}-info`);
                
                if (motores[motorKey]) {
                    const motorData = motores[motorKey];
                    
                    if (motorData.acionar && !motorData.completado) {
                        // ESP32 est√° acionando o motor
                        statusElement.className = 'motor-status acionando';
                        statusElement.innerHTML = `
                            <i class="fas fa-sync-alt fa-spin motor-status-icon"></i>
                            <span>ESP32: Soltando ${getBeverageName(motorData.bebida)}...</span>
                        `;
                        infoElement.textContent = `Acionado: ${new Date(motorData.timestamp).toLocaleTimeString()}`;
                        
                    } else if (motorData.completado) {
                        // ESP32 completou o ciclo
                        statusElement.className = 'motor-status completado';
                        statusElement.innerHTML = `
                            <i class="fas fa-check-circle motor-status-icon"></i>
                            <span>ESP32: ${getBeverageName(motorData.bebida)} entregue!</span>
                        `;
                        infoElement.textContent = `Completado: ${new Date(motorData.timestamp).toLocaleTimeString()}`;
                        
                        // Reset ap√≥s 5 segundos
                        setTimeout(() => {
                            if (motor === 1 && motor1Beverage) {
                                updateMotorButton(1, motor1Beverage);
                            } else if (motor === 2 && motor2Beverage) {
                                updateMotorButton(2, motor2Beverage);
                            }
                        }, 5000);
                    }
                }
            }
        }

        // Configurar listeners para os motores
        function setupMotorListeners() {
            // Motor 1
            document.getElementById('motor1-select').addEventListener('change', function() {
                motor1Beverage = this.value;
                updateMotorButton(1, motor1Beverage);
            });
            
            // Motor 2
            document.getElementById('motor2-select').addEventListener('change', function() {
                motor2Beverage = this.value;
                updateMotorButton(2, motor2Beverage);
            });

            // Bot√£o de soltar refrigerante - Motor 1
            document.getElementById('motor1-release').addEventListener('click', function() {
                if (motor1Beverage) {
                    soltarRefrigerante(1, motor1Beverage);
                }
            });

            // Bot√£o de soltar refrigerante - Motor 2
            document.getElementById('motor2-release').addEventListener('click', function() {
                if (motor2Beverage) {
                    soltarRefrigerante(2, motor2Beverage);
                }
            });
        }

        // Atualizar estado do bot√£o do motor
        function updateMotorButton(motor, beverage) {
            const button = document.getElementById(`motor${motor}-release`);
            const status = document.getElementById(`motor${motor}-status`);
            const info = document.getElementById(`motor${motor}-info`);
            
            if (beverage) {
                button.disabled = isBombaPausada || !isMachineActive;
                button.innerHTML = `<i class="fas fa-cog"></i> Soltar ${getBeverageName(beverage)}`;
                status.className = 'motor-status ready';
                status.innerHTML = `
                    <i class="fas fa-check-circle motor-status-icon"></i>
                    <span>Pronto - ${getBeverageName(beverage)}</span>
                `;
                info.textContent = isBombaPausada ? 'Bomba pausada - N√£o √© poss√≠vel soltar' : 'Clique para enviar comando ao ESP32';
            } else {
                button.disabled = true;
                button.innerHTML = `<i class="fas fa-cog"></i> Soltar Refrigerante`;
                status.className = 'motor-status ready';
                status.innerHTML = `
                    <i class="fas fa-check-circle motor-status-icon"></i>
                    <span>Selecione uma bebida</span>
                `;
                info.textContent = 'Aguardando configura√ß√£o...';
            }
        }

        // ‚úÖ FUN√á√ÉO QUE ENVIA COMANDO PARA O ESP32!
        async function soltarRefrigerante(motor, bebida) {
            if (!isMachineActive) {
                alert('A m√°quina est√° desligada. Ligue-a primeiro para soltar refrigerantes.');
                return;
            }

            if (isBombaPausada) {
                alert('A bomba est√° pausada. Ative-a primeiro para soltar refrigerantes.');
                return;
            }

            try {
                const button = document.getElementById(`motor${motor}-release`);
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Enviando...`;

                // üéØ AQUI ENVIA PARA O ESP32 VIA FIREBASE!
                await window.soltarRefrigerante(motor, bebida);

                const statusElement = document.getElementById(`motor${motor}-status`);
                const infoElement = document.getElementById(`motor${motor}-info`);
                
                statusElement.className = 'motor-status acionando';
                statusElement.innerHTML = `
                    <i class="fas fa-sync-alt fa-spin motor-status-icon"></i>
                    <span>Enviando para ESP32...</span>
                `;
                infoElement.textContent = `Comando enviado: ${new Date().toLocaleTimeString()}`;

                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }, 2000);

            } catch (error) {
                console.error('Erro ao soltar refrigerante:', error);
                alert('Erro ao acionar o motor. Verifique se o ESP32 est√° conectado.');
                
                const button = document.getElementById(`motor${motor}-release`);
                button.disabled = false;
                button.innerHTML = `<i class="fas fa-cog"></i> Soltar ${getBeverageName(bebida)}`;
                
                const statusElement = document.getElementById(`motor${motor}-status`);
                const infoElement = document.getElementById(`${motorKey}-info`);
                
                statusElement.className = 'motor-status erro';
                statusElement.innerHTML = `
                    <i class="fas fa-exclamation-triangle motor-status-icon"></i>
                    <span>Erro de conex√£o ESP32</span>
                `;
                infoElement.textContent = 'Tente novamente';
            }
        }

        // Obter nome da bebida
        function getBeverageName(value) {
            const beverages = {
                'coca-cola': 'Coca-Cola',
                'guarana': 'Guaran√° Antarctica',
                'fanta': 'Fanta Laranja',
                'sprite': 'Sprite',
                'pepsi': 'Pepsi'
            };
            return beverages[value] || value;
        }

        // ============================================================================
        // üî• SISTEMA COMPLETO FIREBASE
        // ============================================================================

        // Inicializar Firebase e carregar dados
        async function initializeFirebase() {
            try {
                updateFirebaseStatus('Conectando...', false);
                
                // Verificar conex√£o com Firebase
                const connectedRef = window.firebaseRef(window.firebaseDB, '.info/connected');
                window.firebaseOnValue(connectedRef, (snap) => {
                    if (snap.val() === true) {
                        updateFirebaseStatus('Conectado', true);
                        loadProductsFromFirebase();
                        loadWithdrawalsFromFirebase();
                        loadStatsFromFirebase();
                        checkAuthState();
                    } else {
                        updateFirebaseStatus('Desconectado', false);
                    }
                });

            } catch (error) {
                console.error('Erro ao inicializar Firebase:', error);
                updateFirebaseStatus('Erro de conex√£o', false);
            }
        }

        // Verificar estado de autentica√ß√£o
        function checkAuthState() {
            window.firebaseAuthStateChanged(window.firebaseAuth, (user) => {
                if (user) {
                    currentUser = user;
                    loadUserData(user.uid);
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('main-container').style.display = 'block';
                } else {
                    currentUser = null;
                    document.getElementById('login-overlay').style.display = 'flex';
                    document.getElementById('main-container').style.display = 'none';
                }
                updateCartDisplay();
            });
        }

        // Carregar dados do usu√°rio
        async function loadUserData(uid) {
            try {
                const userRef = window.firebaseRef(window.firebaseDB, `users/${uid}`);
                const snapshot = await window.firebaseGet(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    showUserInfo(userData);
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usu√°rio:', error);
            }
        }

        // Verificar status da m√°quina
        async function checkMachineStatus() {
            try {
                const comandoRef = window.firebaseRef(window.firebaseDB, "comando");
                window.firebaseOnValue(comandoRef, (snapshot) => {
                    if (snapshot.exists()) {
                        isMachineActive = snapshot.val() === 1;
                        updateMachineStatus();
                    }
                });
            } catch (error) {
                console.error('Erro ao verificar status da m√°quina:', error);
            }
        }

        // Atualizar interface conforme status da m√°quina
        function updateMachineStatus() {
            const addToCartButtons = document.querySelectorAll('.add-to-cart');
            const checkoutBtn = document.getElementById('checkout-btn');
            const motorButtons = document.querySelectorAll('.release-btn');
            const pausarBombaBtn = document.getElementById('pausar-bomba-btn');
            
            if (isMachineActive) {
                addToCartButtons.forEach(btn => btn.disabled = false);
                checkoutBtn.disabled = cart.length === 0 || !currentUser;
                motorButtons.forEach(btn => {
                    if (!btn.disabled) btn.disabled = isBombaPausada;
                });
                pausarBombaBtn.disabled = false;
                document.getElementById('firebase-status-text').textContent = 'M√°quina ATIVA - Conectado';
            } else {
                addToCartButtons.forEach(btn => btn.disabled = true);
                checkoutBtn.disabled = true;
                motorButtons.forEach(btn => btn.disabled = true);
                pausarBombaBtn.disabled = true;
                document.getElementById('firebase-status-text').textContent = 'M√°quina INATIVA - Conectado';
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Login do overlay
            document.getElementById('overlay-login-btn').addEventListener('click', loginUser);
            document.getElementById('overlay-register-btn').addEventListener('click', registerUser);
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', logoutUser);
            
            // Finalizar pedido
            document.getElementById('checkout-btn').addEventListener('click', checkout);
        }

        // Login do usu√°rio
        async function loginUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            try {
                await window.firebaseSignIn(window.firebaseAuth, email, password);
            } catch (error) {
                console.error('Erro no login:', error);
                alert('Erro no login: ' + error.message);
            }
        }

        // Cadastro de usu√°rio
        async function registerUser() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            try {
                const userCredential = await window.firebaseCreateUser(window.firebaseAuth, email, password);
                
                // Salvar informa√ß√µes adicionais do usu√°rio
                const userData = {
                    name: email.split('@')[0],
                    email: email,
                    community: 'Comunidade Local',
                    registrationDate: new Date().toISOString()
                };
                
                const userRef = window.firebaseRef(window.firebaseDB, `users/${userCredential.user.uid}`);
                await window.firebaseSet(userRef, userData);
                
            } catch (error) {
                console.error('Erro no cadastro:', error);
                alert('Erro no cadastro: ' + error.message);
            }
        }

        // Logout do usu√°rio
        async function logoutUser() {
            try {
                await window.firebaseSignOut(window.firebaseAuth);
            } catch (error) {
                console.error('Erro no logout:', error);
            }
        }

        // Mostrar informa√ß√µes do usu√°rio
        function showUserInfo(userData) {
            const userName = document.getElementById('user-name');
            const userDetails = document.getElementById('user-details');
            
            userName.textContent = userData.name;
            userDetails.textContent = `${userData.community} | ${userData.email}`;
        }

        // Atualizar status do Firebase
        function updateFirebaseStatus(message, isConnected) {
            const statusElement = document.getElementById('firebase-status');
            const statusText = document.getElementById('firebase-status-text');
            
            statusText.textContent = message;
            if (isConnected) {
                statusElement.classList.add('connected');
            } else {
                statusElement.classList.remove('connected');
            }
        }

        // Carregar produtos do Firebase
        async function loadProductsFromFirebase() {
            try {
                const productsRef = window.firebaseRef(window.firebaseDB, 'products');
                const snapshot = await window.firebaseGet(productsRef);
                
                if (snapshot.exists()) {
                    products = snapshot.val();
                    renderProducts();
                } else {
                    await createSampleProducts();
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
            }
        }

        // Criar produtos de exemplo
        async function createSampleProducts() {
            const sampleProducts = [
                { id: 1, name: "Coca-Cola", type: "Lata 350ml", stock: 25, price: 0, icon: "fas fa-wine-bottle" },
                { id: 2, name: "Guaran√° Antarctica", type: "Lata 350ml", stock: 18, price: 0, icon: "fas fa-wine-bottle" },
                { id: 3, name: "Fanta Laranja", type: "Lata 350ml", stock: 12, price: 0, icon: "fas fa-wine-bottle" },
                { id: 4, name: "Sprite", type: "Lata 350ml", stock: 15, price: 0, icon: "fas fa-wine-bottle" },
                { id: 5, name: "Pepsi", type: "Lata 350ml", stock: 20, price: 0, icon: "fas fa-wine-bottle" }
            ];

            try {
                const productsRef = window.firebaseRef(window.firebaseDB, 'products');
                await window.firebaseSet(productsRef, sampleProducts);
                products = sampleProducts;
                renderProducts();
            } catch (error) {
                console.error('Erro ao criar produtos de exemplo:', error);
            }
        }

        // Renderizar produtos
        function renderProducts() {
            const productsGrid = document.getElementById('products-grid');
            productsGrid.innerHTML = '';
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <div class="product-image">
                        <i class="${product.icon}"></i>
                    </div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-details">${product.type}</div>
                    <div class="product-stock">Estoque: ${product.stock}</div>
                    <button class="add-to-cart" data-id="${product.id}" ${!isMachineActive ? 'disabled' : ''}>
                        <i class="fas fa-cart-plus"></i> Adicionar
                    </button>
                `;
                productsGrid.appendChild(productCard);
            });

            // Adicionar event listeners aos bot√µes
            document.querySelectorAll('.add-to-cart').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = parseInt(this.getAttribute('data-id'));
                    addToCart(productId);
                });
            });
        }

        // Adicionar ao carrinho
        function addToCart(productId) {
            if (!isMachineActive) {
                alert('A m√°quina est√° desligada. Ligue-a para fazer retiradas.');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity += 1;
                } else {
                    alert(`Estoque insuficiente de ${product.name}. Apenas ${product.stock} unidades dispon√≠veis.`);
                    return;
                }
            } else {
                if (product.stock > 0) {
                    cart.push({
                        id: product.id,
                        name: product.name,
                        type: product.type,
                        quantity: 1
                    });
                } else {
                    alert(`Produto ${product.name} fora de estoque.`);
                    return;
                }
            }
            
            updateCartDisplay();
        }

        // Atualizar carrinho
        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const cartTotal = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            const leadTimeResult = document.getElementById('lead-time-result');
            
            cartItems.innerHTML = '';
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p style="text-align: center; opacity: 0.7;">Carrinho vazio</p>';
                cartTotal.textContent = 'Total de Itens: 0';
                checkoutBtn.disabled = true;
                leadTimeResult.textContent = 'Tempo estimado: 0 minutos';
                return;
            }
            
            let totalItems = 0;
            
            cart.forEach(item => {
                totalItems += item.quantity;
                
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-details">${item.type}</div>
                    </div>
                    <div class="cart-item-controls">
                        <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantity-btn increase" data-id="${item.id}">+</button>
                        <button class="remove-btn" data-id="${item.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                cartItems.appendChild(cartItem);
            });
            
            // Event listeners para controles do carrinho
            document.querySelectorAll('.quantity-btn.decrease').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    decreaseQuantity(id);
                });
            });
            
            document.querySelectorAll('.quantity-btn.increase').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    increaseQuantity(id);
                });
            });
            
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    removeFromCart(id);
                });
            });
            
            cartTotal.textContent = `Total de Itens: ${totalItems}`;
            checkoutBtn.disabled = !currentUser || !isMachineActive;
            
            // Calcular lead time
            const leadTimeMinutes = 2 + (totalItems * 0.5);
            leadTimeResult.textContent = `Tempo estimado: ${leadTimeMinutes.toFixed(1)} minutos`;
        }

        // Fun√ß√µes do carrinho
        function decreaseQuantity(productId) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                if (item.quantity > 1) {
                    item.quantity -= 1;
                } else {
                    removeFromCart(productId);
                    return;
                }
                updateCartDisplay();
            }
        }

        function increaseQuantity(productId) {
            const item = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (item && product && item.quantity < product.stock) {
                item.quantity += 1;
                updateCartDisplay();
            } else if (item && product && item.quantity >= product.stock) {
                alert(`Estoque insuficiente de ${product.name}. Apenas ${product.stock} unidades dispon√≠veis.`);
            }
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }

        // Finalizar pedido
        async function checkout() {
            if (cart.length === 0 || !currentUser || !isMachineActive) {
                alert('N√£o √© poss√≠vel finalizar a retirada.');
                return;
            }
            
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            const leadTimeMinutes = 2 + (totalItems * 0.5);
            
            // Registrar retirada no Firebase
            const withdrawal = {
                user: currentUser.uid,
                userName: document.getElementById('user-name').textContent,
                items: [...cart],
                date: new Date().toISOString(),
                leadTime: leadTimeMinutes.toFixed(1),
                status: 'completed'
            };
            
            try {
                const withdrawalsRef = window.firebaseRef(window.firebaseDB, 'withdrawals');
                await window.firebasePush(withdrawalsRef, withdrawal);
                
                // Atualizar estoque
                await updateStock();
                
                // Limpar carrinho
                cart = [];
                updateCartDisplay();
                
                alert(`Retirada confirmada! Tempo estimado: ${leadTimeMinutes.toFixed(1)} minutos.`);
                
            } catch (error) {
                console.error('Erro ao registrar retirada:', error);
                alert('Erro ao processar retirada.');
            }
        }

        // Atualizar estoque no Firebase
        async function updateStock() {
            try {
                for (const item of cart) {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        product.stock -= item.quantity;
                    }
                }
                
                const productsRef = window.firebaseRef(window.firebaseDB, 'products');
                await window.firebaseSet(productsRef, products);
                
            } catch (error) {
                console.error('Erro ao atualizar estoque:', error);
            }
        }

        // Carregar retiradas do Firebase
        async function loadWithdrawalsFromFirebase() {
            try {
                const withdrawalsRef = window.firebaseRef(window.firebaseDB, 'withdrawals');
                window.firebaseOnValue(withdrawalsRef, (snapshot) => {
                    if (snapshot.exists()) {
                        withdrawals = Object.values(snapshot.val());
                        renderWithdrawals();
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar retiradas:', error);
            }
        }

        // Renderizar retiradas
        function renderWithdrawals() {
            const withdrawalsList = document.getElementById('withdrawals-list');
            withdrawalsList.innerHTML = '';
            
            if (withdrawals.length === 0) {
                withdrawalsList.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nenhuma retirada registrada</p>';
                return;
            }
            
            const recentWithdrawals = withdrawals.slice(-10).reverse();
            
            recentWithdrawals.forEach(withdrawal => {
                const withdrawalItem = document.createElement('div');
                withdrawalItem.className = 'withdrawal-item';
                
                const itemsText = withdrawal.items.map(item => `${item.quantity}x ${item.name}`).join(', ');
                const date = new Date(withdrawal.date).toLocaleString('pt-BR');
                
                withdrawalItem.innerHTML = `
                    <div>
                        <strong>${withdrawal.userName}</strong>
                        <div style="font-size: 0.9rem; opacity: 0.8;">${itemsText}</div>
                    </div>
                    <div style="text-align: right;">
                        <div>${date}</div>
                        <div style="font-size: 0.9rem; color: #00ff88;">${withdrawal.leadTime} min</div>
                    </div>
                `;
                
                withdrawalsList.appendChild(withdrawalItem);
            });
        }

        // Carregar estat√≠sticas
        async function loadStatsFromFirebase() {
            // Simula√ß√£o de estat√≠sticas
            document.getElementById('today-withdrawals').textContent = withdrawals.length;
            document.getElementById('active-users').textContent = '15';
            
            const totalStock = products.reduce((sum, product) => sum + product.stock, 0);
            document.getElementById('total-stock').textContent = totalStock;
            
            document.getElementById('partner-cost').textContent = 'R$ ' + (withdrawals.length * 2.5).toFixed(2);
        }

        // Alternar entre abas
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab:nth-child(${tabName === 'user' ? 1 : 2})`).classList.add('active');
            
            if (tabName === 'admin') {
                loadStatsFromFirebase();
                renderWithdrawals();
            }
        }

        // Fun√ß√£o para ligar/desligar m√°quina
        async function enviarComando(valor) {
            try {
                const comandoRef = window.firebaseRef(window.firebaseDB, "comando");
                await window.firebaseSet(comandoRef, valor);
                
                const status = valor === 1 ? 'LIGADA' : 'DESLIGADA';
                alert(`M√°quina ${status} com sucesso!`);
                
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao enviar comando para a m√°quina");
            }
        }
    </script>
</body>
</html>